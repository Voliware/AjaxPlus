"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function deepCopy(e,t,n){if(null===e||"object"!==("undefined"==typeof e?"undefined":_typeof(e)))return e;if("function"==typeof e.clone)return e.clone(!0);if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e);if(e.nodeType&&"function"==typeof e.cloneNode)return e.cloneNode(!0);void 0===t&&(t=[],n=[]);var i,r=t.length;for(i=0;i<r;i++)if(e===t[i])return n[i];if("[object Array]"==Object.prototype.toString.call(e)){var s=e.slice();for(t.push(e),n.push(s),i=s.length;i--;)s[i]=deepCopy(s[i],t,n);return s}var u=Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__;u||(u=e.constructor.prototype);var o=object_create(u);t.push(e),n.push(o);for(var a in e)o[a]=deepCopy(e[a],t,n);return o}var _get=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,n,i)}if("value"in r)return r.value;var u=r.get;if(void 0!==u)return u.call(i)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Util=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"each",value:function(e,t){for(var n in e){var i=e[n];t(n,i)}}}]),e}();"undefined"==typeof isDefined&&(window.isDefined=function(e){return"undefined"!=typeof e}),"undefined"==typeof isNull&&(window.isNull=function(e){return null===e}),"undefined"==typeof isFunction&&(window.isFunction=function(e){return"function"==typeof e}),"undefined"==typeof isString&&(window.isString=function(e){return"string"==typeof e}),"undefined"==typeof isNumber&&(window.isNumber=function(e){return"number"==typeof e}),"undefined"==typeof isObject&&(window.isObject=function(e){return null!==e&&"object"===("undefined"==typeof e?"undefined":_typeof(e))}),"undefined"==typeof isArray&&(window.isArray=function(e){return null!==e&&Array.isArray(e)}),"undefined"==typeof getType&&(window.getType=function(e){return null===e?"[object Null]":Object.prototype.toString.call(e)}),"undefined"==typeof createGuid&&(window.createGuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}),"undefined"==typeof Array.diff&&(Array.diff=function(e,t){return e.filter(function(e){return t.indexOf(e)<0})}),"undefined"==typeof Array.min&&(Array.min=function(e){return Math.min.apply(Math,e)}),"undefined"==typeof Array.max&&(Array.max=function(e){return Math.max.apply(Math,e)}),"function"!=typeof Object.assign&&(Object.assign=function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");e=Object(e);for(var t=1;t<arguments.length;t++){var n=arguments[t];if(null!=n)for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e});var object_create=Object.create;"function"!=typeof object_create&&(object_create=function(e){function t(){}return t.prototype=e,new t});var EventSystem=function(){function e(){return _classCallCheck(this,e),this.events={},this}return _createClass(e,[{key:"_createEvent",value:function(e){return this.events[e]={callbacks:[]}}},{key:"_destroy",value:function(e){return isDefined(this.event[e])&&delete this.event[e],this}},{key:"on",value:function(e,t){var n=this.events[e];return isDefined(n)||(n=this._createEvent(e)),n.callbacks.push(t),this}},{key:"off",value:function(e,t){var n=this.events[e];if(isDefined(n)){var i=n.callbacks.indexOf(t);i>-1&&n.callbacks.splice(i,1)}return this}},{key:"offAll",value:function(e){var t=this.events[e];return isDefined(t)&&(t[e].callbacks=[]),this}},{key:"trigger",value:function(){var e=[].shift,t=e.apply(arguments),n=this.events[t];if(!isDefined(n))return this;for(var i=0;i<n.callbacks.length;i++){var r;(r=n.callbacks)[i].apply(r,arguments)}return this}},{key:"emit",value:function(){return this.trigger()}}]),e}(),AjaxModule=function(e){function t(e){var n;if(_classCallCheck(this,t),!isDefined(e))throw new ReferenceError("AjaxModule.constructor: must pass an options object");var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r={request:null,interval:1e4,async:!0,url:"",data:"",dataType:"json",type:"GET",username:"",password:""};return i.settings=$.extend(r,e),i.interval=null,i._cachedData={},i._processedData={},i.isFirstUpdate=!0,i._request=i.settings.request?i._useRequest.bind(i):i._useOptions.bind(i),n=i,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"request",value:function(){var e=this;return this._request().done(function(t){e._cacheData(t),e._processData(t),e._done(e._processedData)}).fail(function(t){e._fail(t)}).always(function(){e._always(),e.isFirstUpdate=!1})}},{key:"_useRequest",value:function(){return this.settings.request()}},{key:"_useOptions",value:function(){var e=this.settings;return $.ajax({type:e.type,url:e.url,dataType:e.dataType,async:e.async,username:e.username,password:e.password,data:e.data})}},{key:"_done",value:function(e){return this.trigger("done",e),this}},{key:"_fail",value:function(e){return this.trigger("fail",e),this}},{key:"_always",value:function(){return this.trigger("always"),this}},{key:"_cacheData",value:function(e){return this._cachedData=$.extend(!0,{},e),this}},{key:"_processData",value:function(e){return this._processedData=$.extend(!0,{},e),this}},{key:"start",value:function(){return this.stop(),this.interval=setInterval(this.request.bind(this),this.settings.interval),this.request()}},{key:"stop",value:function(){return clearInterval(this.interval),this}}]),t}(EventSystem),AjaxPoll=function(e){function t(e){var n;_classCallCheck(this,t);var i={url:"",maxPolls:10,maxFails:10,expectation:1},r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,$.extend(i,e)));return r.polls=0,r.fails=0,r.dfd=$.Deferred(),n=r,_possibleConstructorReturn(r,n)}return _inherits(t,e),_createClass(t,[{key:"_done",value:function(e){return this._checkExpectation(e),this}},{key:"_fail",value:function(e){return this.settings.maxFails>0&&(this.fails++,this._checkFailure(e)),this}},{key:"_always",value:function(){return this.settings.maxPolls>0&&(this.polls++,this._checkPolls()),this}},{key:"_checkExpectation",value:function(e){var t=this.settings.expectation;return(t===e||"function"==typeof t&&t(e))&&(this.dfd.resolve(e),this.stop(),this.trigger("done",e),this.trigger("always")),this}},{key:"_checkPolls",value:function(e){return this.polls>=this.settings.maxPolls&&(this.dfd.reject(),this.stop(),this.trigger("fail",e),this.trigger("always")),this}},{key:"_checkFailure",value:function(e){return this.fails>=this.settings.maxFails&&(this.dfd.reject(),this.stop(),this.trigger("fail",e),this.trigger("always")),this}},{key:"start",value:function(){return _get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this.dfd=$.Deferred(),this.dfd.promise()}}]),t}(AjaxModule),AjaxMonitor=function(e){function t(e){var n;if(_classCallCheck(this,t),!isDefined(e))throw new ReferenceError("AjaxMonitor.constructor: options.heartbeatUrl argument is required.");var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r=i,s={heartbeatUrl:"",maxFailures:4,ajaxTimeout:0,resetTimer:1e4,abortOnDisconnect:!0};return i.settings=$.extend(s,e),i.heartbeat=new AjaxModule({url:i.settings.heartbeatUrl,data:{heartbeat:1},interval:5e3}),i.interval=null,i.failures=0,i.isConnected=!0,i.settings.ajaxTimeout>0&&$.ajaxSetup({timeout:i.settings.ajaxTimeout}),function(e){XMLHttpRequest.prototype.open=function(t,n,i,s,u){return this.addEventListener("readystatechange",function(){1===this.readyState&&r.settings.abortOnDisconnect&&!r.isConnected&&n.indexOf("heartbeat")===-1&&this.abort()},!1),this.addEventListener("abort",function(){r._fail()},!1),this.addEventListener("error",function(){r._fail()},!1),this.addEventListener("timeout",function(){r._fail()},!1),this.addEventListener("load",function(){r._done()},!1),e.apply(this,arguments)}}(XMLHttpRequest.prototype.open),n=i,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"_done",value:function(){return this.failures=0,this.checkLimit(),this}},{key:"_fail",value:function(){return this.failures++,this.checkLimit(),this}},{key:"start",value:function(){return this.interval=setInterval(this.reset,this.settings.interval),this}},{key:"stop",value:function(){return clearInterval(this.interval),this}},{key:"reset",value:function(){return this.failures=0,this}},{key:"checkLimit",value:function(){var e=this.isConnected;return this.isConnected=this.failures<=this.settings.maxFailures,e!==this.isConnected&&(this.isConnected?(this.trigger("connected"),this.start(),this.heartbeat.stop()):(this.trigger("disconnected"),this.stop(),this.heartbeat.start())),this}}]),t}(EventSystem),AjaxQueue=function(e){function t(e){var n;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r={size:100,delay:0,activeRequestLimit:1,abortOnFail:!1};return i.queue=[],i.settings=$.extend(r,e),i.activeRequests=0,n=i,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"_next",value:function(){return this.settings.delay>0?setTimeout(this.dequeue.bind(this),this.settings.delay):this.dequeue(),this}},{key:"enqueue",value:function(){if(this.queue.length<=this.settings.size){var e;(e=this.queue).push.apply(e,arguments),this.dequeue()}else console.warn("AjaxQueue.enqueue: queue size is at limit");return this}},{key:"dequeue",value:function(){if(this.queue.length>0&&this.activeRequests<this.settings.activeRequestLimit){var e=this,t=this.queue.pop();this.activeRequests++,t().done(function(){e.activeRequests--,e._next()}).fail(function(){return e.activeRequests--,e.settings.abortOnFail?(e.queue=[],e.activeRequests=0,this):void e._next()})}return this}}]),t}(EventSystem),AjaxSequence=function(e){function t(e){var n;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.currentRequest=0,i.requestData=[],n=i,_possibleConstructorReturn(i,n)}return _inherits(t,e),_createClass(t,[{key:"enqueue",value:function(){var e;return this.queue.length<=this.settings.size?(e=this.queue).push.apply(e,arguments):console.warn("AjaxSequence.enqueue: queue size is at limit"),this}},{key:"dequeue",value:function(){function e(e){n.currentRequest++,n.requestData.push(e),n.dequeue(t)}var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$.Deferred(),n=this;if(this.queue.length===this.currentRequest){var i=this.requestData;this.currentRequest=0,this.requestData=[],t.resolve(i)}else this.queue[this.currentRequest]().done(function(t){e(t)}).fail(function(i){n.settings.abortOnFail?t.reject(i):e(i)});return t.promise()}}]),t}(AjaxQueue);