"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _get=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(i)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),Util=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"each",value:function(t,e){for(var n in t){var i=t[n];e(n,i)}}}]),t}();"undefined"==typeof isDefined&&(window.isDefined=function(t){return"undefined"!=typeof t}),"undefined"==typeof isNull&&(window.isNull=function(t){return null===t}),"undefined"==typeof isFunction&&(window.isFunction=function(t){return"function"==typeof t}),"undefined"==typeof isString&&(window.isString=function(t){return"string"==typeof t}),"undefined"==typeof isNumber&&(window.isNumber=function(t){return"number"==typeof t}),"undefined"==typeof isObject&&(window.isObject=function(t){return null!==t&&"object"===("undefined"==typeof t?"undefined":_typeof(t))}),"undefined"==typeof getType&&(window.getType=function(t){return null===t?"[object Null]":Object.prototype.toString.call(t)}),"undefined"==typeof createGuid&&(window.createGuid=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}),"undefined"==typeof Array.diff&&(Array.diff=function(t,e){return t.filter(function(t){return e.indexOf(t)<0})}),"undefined"==typeof Array.min&&(Array.min=function(t){return Math.min.apply(Math,t)}),"undefined"==typeof Array.max&&(Array.max=function(t){return Math.max.apply(Math,t)}),"function"!=typeof Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");t=Object(t);for(var e=1;e<arguments.length;e++){var n=arguments[e];if(null!=n)for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t});var EventSystem=function(){function t(){return _classCallCheck(this,t),this.events={},this}return _createClass(t,[{key:"_createEvent",value:function(t){return this.events[t]={callbacks:[]}}},{key:"_destroy",value:function(t){return isDefined(this.event[t])&&delete this.event[t],this}},{key:"on",value:function(t,e){var n=this.events[t];return isDefined(n)||(n=this._createEvent(t)),n.callbacks.push(e),this}},{key:"off",value:function(t,e){var n=this.events[t];if(isDefined(n)){var i=n.callbacks.indexOf(e);i>-1&&n.callbacks.splice(i,1)}return this}},{key:"offAll",value:function(t){var e=this.events[t];return isDefined(e)&&(e[t].callbacks=[]),this}},{key:"trigger",value:function(){var t=[].shift,e=t.apply(arguments),n=this.events[e];if(!isDefined(n))return this;for(var i=0;i<n.callbacks.length;i++){var r;(r=n.callbacks)[i].apply(r,arguments)}return this}},{key:"emit",value:function(){return this.trigger()}}]),t}(),AjaxModule=function(t){function e(t){var n;if(_classCallCheck(this,e),!isDefined(t))throw new ReferenceError("AjaxModule.constructor: must pass an options object or an AJAX call");var i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this)),r={request:null,interval:1e4,async:!0,url:"",data:"",dataType:"json",type:"GET",username:"",password:""};return i.settings=$.extend(r,t),i.interval=null,i.isFirstUpdate=!0,i._cachedData={},i._request=i.settings.request?i._useRequest.bind(i):i._useOptions.bind(i),n=i,_possibleConstructorReturn(i,n)}return _inherits(e,t),_createClass(e,[{key:"_req",value:function(){var t=this;return this._request().done(function(e){t._cacheData(e),e=t._processData(e),t._done(e),t.trigger("done",e)}).fail(function(e){t._fail(e),t.trigger("fail",e)}).always(function(){t._always(),t.trigger("always"),t.isFirstUpdate=!1})}},{key:"_useRequest",value:function(){return this.settings.request()}},{key:"_useOptions",value:function(){var t=this.settings;return $.ajax({type:t.type,url:t.url,dataType:t.dataType,async:t.async,username:t.username,password:t.password,data:t.data})}},{key:"_done",value:function(t){}},{key:"_fail",value:function(t){}},{key:"_always",value:function(){}},{key:"_cacheData",value:function(t){return this._cachedData=$.extend(!0,{},t),this}},{key:"_processData",value:function(t){return t}},{key:"start",value:function(){return this.interval=setInterval(this._req.bind(this),this.settings.interval),this._req()}},{key:"stop",value:function(){return clearInterval(this.interval),this}}]),e}(EventSystem),AjaxPoll=function(t){function e(t){var n;_classCallCheck(this,e);var i={url:"",maxPolls:10,maxFails:10,expectation:1},r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,$.extend(i,t)));return r.polls=0,r.fails=0,r.dfd=$.Deferred(),n=r,_possibleConstructorReturn(r,n)}return _inherits(e,t),_createClass(e,[{key:"_done",value:function(t){return this._checkExpectation(t),this}},{key:"_fail",value:function(t){return this.settings.maxFails>0&&(this.fails++,this._checkFailure()),this}},{key:"_always",value:function(){return this.settings.maxPolls>0&&(this.polls++,this._checkPolls()),this}},{key:"_checkExpectation",value:function(t){var e=this.settings.expectation;return(e===t||"function"==typeof e&&e(t))&&(this.dfd.resolve(t),this.stop()),this}},{key:"_checkPolls",value:function(){return this.polls>=this.settings.maxPolls&&(this.dfd.reject(),this.stop()),this}},{key:"_checkFailure",value:function(){return this.fails>=this.settings.maxFails&&(this.dfd.reject(),this.stop()),this}},{key:"start",value:function(){return _get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"start",this).call(this),this.dfd.promise()}}]),e}(AjaxModule),AjaxMonitor=function(t){function e(t){var n;if(_classCallCheck(this,e),!isDefined(t))throw new ReferenceError("AjaxMonitor.constructor: options.heartbeatUrl argument is required.");var i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this)),r=i,s={heartbeatUrl:"",maxFailures:4,ajaxTimeout:0,resetTimer:1e4,abortOnDisconnect:!0};return i.settings=$.extend(s,t),i.heartbeat=new AjaxModule({url:i.settings.heartbeatUrl,data:{heartbeat:1},interval:5e3}),i.interval=null,i.failures=0,i.isConnected=!0,i.settings.ajaxTimeout>0&&$.ajaxSetup({timeout:i.settings.ajaxTimeout}),function(t){XMLHttpRequest.prototype.open=function(e,n,i,s,o){return this.addEventListener("readystatechange",function(){1===this.readyState&&r.settings.abortOnDisconnect&&!r.isConnected&&n.indexOf("heartbeat")===-1&&this.abort()},!1),this.addEventListener("abort",function(){r._fail()},!1),this.addEventListener("error",function(){r._fail()},!1),this.addEventListener("timeout",function(){r._fail()},!1),this.addEventListener("load",function(){r._done()},!1),t.apply(this,arguments)}}(XMLHttpRequest.prototype.open),n=i,_possibleConstructorReturn(i,n)}return _inherits(e,t),_createClass(e,[{key:"_done",value:function(){return this.failures=0,this.checkLimit(),this}},{key:"_fail",value:function(){return this.failures++,this.checkLimit(),this}},{key:"start",value:function(){return this.interval=setInterval(this.reset,this.settings.interval),this}},{key:"stop",value:function(){return clearInterval(this.interval),this}},{key:"reset",value:function(){return this.failures=0,this}},{key:"checkLimit",value:function(){var t=this.isConnected;return this.isConnected=this.failures<=this.settings.maxFailures,t!==this.isConnected&&(this.isConnected?(this.trigger("connected"),this.start(),this.heartbeat.stop()):(this.trigger("disconnected"),this.stop(),this.heartbeat.start())),this}}]),e}(EventSystem),AjaxQueue=function(t){function e(t){var n;_classCallCheck(this,e);var i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this)),r={size:100,delay:0,abortOnFail:!1};return i.settings=$.extend(r,t),i.queue=[],i.inProgress=!1,n=i,_possibleConstructorReturn(i,n)}return _inherits(e,t),_createClass(e,[{key:"_next",value:function(){return this.inProgress=!1,this.settings.delay>0?setTimeout(this.dequeue.bind(this),this.settings.delay):this.dequeue(),this}},{key:"enqueue",value:function(){if(this.queue.length<this.settings.size){var t;(t=this.queue).push.apply(t,arguments),this.dequeue()}else console.warn("AjaxQueue.enqueue: queue size is at limit");return this}},{key:"dequeue",value:function(){if(this.queue.length>0&&!this.inProgress){var t=this,e=this.queue.pop();e().fail(function(){return t.settings.abortOnFail?(t.queue=[],this):void t._next()}).done(function(){t._next()})}return this}}]),e}(EventSystem);